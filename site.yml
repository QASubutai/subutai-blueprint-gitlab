# Ansible Playbook for Subutai GitLab blueprint
# Tue May 22 15:49:23 -03 2018
# Author: arthurpbs at gmail dot com
# Version: 0.1
---

- hosts: all
  gather_facts: false
  remote_user: root
  tasks: 

    - name: Update
      raw: apt-get -y --allow-unauthenticated update || true

    - name: Ensure python is available
      raw: test -e /usr/bin/python || apt install -y --allow-unauthenticated python-minimal

    - name: Ensure python-apt is available
      raw: test -d /usr/share/python-apt || apt install -y --allow-unauthenticated python-apt

    - name: Add gitlab deb source
      raw: curl https://packages.gitlab.com/install/repositories/gitlab/gitlab-ee/script.deb.sh | bash

    - name: Upgrade
      raw: apt-get -y --allow-unauthenticated upgrade

- hosts: gl
  remote_user: root
  tasks: 

        - name: Install GitLab dependencies.
          package: name={{ item }} state=present
          with_items:
            - openssh-server
            - curl
            - openssl
            - tzdata
            - ca-certificates

        - name: Install GitLab CE
          shell: apt-get -y --allow-unauthenticated install gitlab-ee
          ignore_errors: yes
          environment:
              EXTERNAL_URL: "{{ domain_name }}"

        - name: Run GitLab Reconfigure
          command: gitlab-ctl reconfigure
